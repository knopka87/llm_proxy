{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "CHECK.response.v1",
  "type": "object",
  "required": [
    "status",
    "can_evaluate",
    "decision",
    "feedback",
    "error_spans",
    "confidence",
    "photo_quality",
    "failure_reason",
    "debug"
  ],
  "additionalProperties": false,
  "properties": {
    "status": {
      "type": "string",
      "enum": [
        "evaluated",
        "need_better_photo",
        "no_answer",
        "internal_error"
      ],
      "description": "Статус обработки: ответ проверен, нужно лучшее фото, ответа не видно, внутренняя ошибка."
    },
    "can_evaluate": {
      "type": "boolean",
      "description": "Может ли модуль честно оценить ответ (true — да, false — нет, попросит переснять или дописать ответ)."
    },
    "decision": {
      "type": "string",
      "enum": [
        "correct",
        "incorrect",
        "need_annotation",
        "invalid_expected",
        "cannot_evaluate"
      ],
      "description": "P0.3: Результат проверки: correct/incorrect при can_evaluate=true; cannot_evaluate/need_annotation/invalid_expected при невозможности оценки."
    },
    "is_correct": {
      "type": [
        "boolean",
        "null"
      ],
      "description": "DEPRECATED: используйте decision. Для обратной совместимости: true/false при decision=correct/incorrect; null в остальных случаях.",
      "default": null
    },
    "feedback": {
      "type": "string",
      "description": "Сообщение для ученика/родителя (коротко, простым языком). P1.1: При incorrect НЕ давать полное решение — только подсказку."
    },
    "error_spans": {
      "type": [
        "array",
        "null"
      ],
      "description": "Опциональный массив указаний, где именно ошибка в ответе.",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "from": {
            "type": "integer",
            "description": "Начальная позиция диапазона ошибки (в символах или условных позициях)."
          },
          "to": {
            "type": "integer",
            "description": "Конечная позиция диапазона ошибки."
          },
          "label": {
            "type": "string",
            "description": "Краткое текстовое описание типа ошибки."
          }
        },
        "required": [
          "from",
          "to",
          "label"
        ]
      },
      "default": null
    },
    "confidence": {
      "type": [
        "number",
        "null"
      ],
      "minimum": 0.0,
      "maximum": 1.0,
      "description": "Оценка уверенности модели в результате проверки (0–1). null если can_evaluate=false.",
      "default": null
    },
    "photo_quality": {
      "type": [
        "object",
        "null"
      ],
      "additionalProperties": false,
      "description": "Оценка качества фотографии ответа.",
      "properties": {
        "score": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Числовая оценка качества фото (0–1)."
        },
        "label": {
          "type": "string",
          "enum": [
            "low",
            "medium",
            "high"
          ],
          "description": "Качественная оценка фото: низкое, среднее, высокое качество."
        }
      },
      "default": null,
      "required": [
        "score",
        "label"
      ]
    },
    "failure_reason": {
      "type": [
        "string",
        "null"
      ],
      "enum": [
        "bad_photo",
        "no_visible_answer",
        "unsupported_subject",
        "task_struct_incomplete",
        "ground_truth_unverified",
        "parse_inconsistency",
        "internal_error",
        null
      ],
      "description": "Машинно-читаемый код причины, почему can_evaluate=false. P0.1: parse_inconsistency при противоречии final_answer и solution_steps. ground_truth_unverified при невозможности доказать эталон.",
      "default": null
    },
    "debug": {
      "type": [
        "object",
        "null"
      ],
      "additionalProperties": false,
      "description": "Диагностическая информация для логов (НЕ показывать пользователю).",
      "properties": {
        "raw_answer_text": {
          "type": [
            "string",
            "null"
          ],
          "description": "Транскрипция/прочитанный текст ответа с фото."
        },
        "normalized_answer": {
          "type": [
            "string",
            "null"
          ],
          "description": "Нормализованный ответ в каноническом виде."
        },
        "expected_answer": {
          "type": [
            "string",
            "null"
          ],
          "description": "P2.2: Эталонный ответ, с которым сравнивали (из PARSE или вычисленный)."
        },
        "decision_reason": {
          "type": [
            "string",
            "null"
          ],
          "description": "P2.2: Причина решения (matched_parse, independent_verification, parse_inconsistency и т.д.)."
        }
      },
      "default": null,
      "required": [
        "raw_answer_text",
        "normalized_answer"
      ]
    }
  }
}
