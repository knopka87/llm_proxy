{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "check.schema.json",
  "title": "CHECK_SOLUTION Output Schema (v1.1)",
  "type": "object",
  "additionalProperties": false,
  "required": ["verdict", "comparison"],
  "properties": {
    "verdict": {
      "type": "string",
      "enum": ["correct", "incorrect", "uncertain"]
    },
    "short_hint": {
      "type": "string",
      "maxLength": 120
    },
    "reason_codes": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": [
          "units_missing",
          "units_mismatch",
          "not_within_tolerance",
          "order_error",
          "missing_step",
          "extra_steps",
          "missing_items",
          "extra_items",
          "typo_detected",
          "synonym_mismatch",
          "regex_mismatch",
          "format_ambiguous",
          "shape_mismatch",
          "low_confidence",
          "needs_clarification"
        ]
      },
      "maxItems": 2
    },
    "comparison": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "units": {
          "oneOf": [
            { "type": "null" },
            {
              "type": "object",
              "additionalProperties": false,
              "required": ["detected"],
              "properties": {
                "detected": { "type": ["string", "null"] },
                "applied": { "type": ["string", "null"] }
              }
            }
          ]
        },
        "number_diff": {
          "oneOf": [
            { "type": "null" },
            {
              "type": "object",
              "additionalProperties": false,
              "required": ["within_tolerance"],
              "properties": {
                "within_tolerance": { "type": "boolean" }
              }
            }
          ]
        },
        "string_match": {
          "oneOf": [
            { "type": "null" },
            {
              "type": "object",
              "additionalProperties": false,
              "required": ["mode"],
              "properties": {
                "mode": {
                  "type": "string",
                  "enum": ["exact", "regex", "synonym", "case_fold"]
                }
              }
            }
          ]
        },
        "list_match": {
          "oneOf": [
            { "type": "null" },
            {
              "type": "object",
              "additionalProperties": false,
              "required": ["total", "extra"],
              "properties": {
                "total": { "type": "integer", "minimum": 0 },
                "extra": { "type": "integer", "minimum": 0 },
                "missing": {
                  "type": "array",
                  "items": { "type": "string" }
                }
              }
            }
          ]
        },
        "steps_match": {
          "oneOf": [
            { "type": "null" },
            {
              "type": "object",
              "additionalProperties": false,
              "required": ["order_ok"],
              "properties": {
                "missing": {
                  "type": "array",
                  "items": { "type": "string" }
                },
                "order_ok": { "type": "boolean" },
                "extra_steps": {
                  "type": "array",
                  "items": { "type": "string" }
                }
              }
            }
          ]
        }
      }
    },
    "next_action_code": {
      "type": "string",
      "enum": [
        "ask_retry",
        "offer_L2",
        "offer_L3",
        "show_analogue",
        "ask_rephoto",
        "ask_clarify_units"
      ]
    },
    "speakable_message": {
      "type": "string",
      "maxLength": 140
    }
  }
}